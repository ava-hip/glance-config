- name: medias
  columns:
    - size: small
      widgets:
        - type: calendar
          first-day-of-week: monday
          hide-header: true

        - type: weather
          units: metric
          hour-format: 24h
          location: Montpellier, France
          hide-header: true

        - type: to-do
          title: To-do
          id: todo
          hide-header: true
          
        - type: custom-api
          title: Gluetun status
          cache: 1m
          url: ${GLUETUN_URL}/v1/publicip/ip
          headers:
            X-API-Key: ${GLUETUN_API_KEY}
          template: |
            {{ if eq .Response.StatusCode 200 }}
              {{ $ip := (.JSON.String "public_ip") }}
              {{ $city := (.JSON.String "city") }}
              {{ $country := (.JSON.String "country") }}
              {{ if eq $ip "" }}
                <div>
                  <div>
                    <div>
                      <div class="color-highlight size-h3">
                        Your VPN is not connected!
                        <span class="color-negative">●</span> 
                      </div>
                    </div>
                  </div>
                </div>
              {{ else }}
                <div>
                  <div>
                    <div>
                      <div class="color-highlight size-h3">
                        Your VPN is connected!
                        <span class="color-positive">●</span> 
                      </div>
                    </div>
                    <div class="size-h5">{{ $ip }} - {{ $city }}, {{ $country }}</div>
                  </div>
                </div>
              {{ end }}
            {{ else }}
              <div style="text-align: center; color: var(--color-negative);">
                Error: {{ .Response.StatusCode }} - {{ .Response.Status }}
              </div>
            {{ end }}

    - size: full
      widgets:
        - type: split-column
          max-columns: 3
          widgets:
            - type: custom-api
              title: Recently Added
              cache: 5m
              url: ${TAUTULLI_URL}/api/v2?apikey=${TAUTULLI_KEY}&cmd=get_recently_added&count=10
              options:
                size: "small"
                collapse: 5
              template: |
                {{ $isLarge := eq (.Options.StringOr "size" "large") "large" }}
                {{ $uniqueID := "recently_added" }}
                {{ $collapse := .Options.IntOr "collapse" 5 }}
                {{ $rows := .JSON.Array "response.data.recently_added" }}
                {{ if $isLarge }}
                  <!-- Large View -->
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <!-- Left Arrow -->
                    <div id="scrollLeft-{{ $uniqueID }}" onclick='document.getElementById("scrollContainer-{{ $uniqueID }}").scrollBy({ left: -150, behavior: "smooth" })'
                      style="flex: 0 0 2.5rem; height: 100px; display: flex; align-items: center; justify-content: center; background: var(--color-surface); cursor: pointer;">
                      <span class="color-primary" style="font-size: 1.5rem; opacity: 0.7;">◀</span>
                    </div>
                    <!-- Scroll Content -->
                    <div id="scrollContainer-{{ $uniqueID }}"
                      style="display: flex; overflow-x: auto; gap: 1rem; padding-block: 0.5rem; scroll-behavior: smooth; scrollbar-width: none; -ms-overflow-style: none;">
                      {{ range $i, $v := $rows }}
                        {{ $type := $v.String "media_type" }}
                        {{ $isEpisode := eq $type "episode" }}
                        {{ $isMovie := eq $type "movie" }}
                        {{ $isSeason := eq $type "season" }}
                        {{ $isShow := eq $type "show" }}
                        {{ $ratingKey := $v.String "rating_key" }}
                        {{ $lastWatch := printf "%d" ($v.Int "added_at") }}
                        {{ $img := "" }}
                        {{ $title := "" }}
                        {{ $sub := "" }}
                        {{ if $isEpisode }}
                          {{ $img = $v.String "grandparent_thumb" }}
                          {{ $title = $v.String "grandparent_title" }}
                          {{ $sub = printf "S%d · E%d" ($v.Int "parent_media_index") ($v.Int "media_index") }}
                        {{ else if $isMovie }}
                          {{ $img = $v.String "thumb" }}
                          {{ $title = $v.String "title" }}
                          {{ $sub = printf "%d" ($v.Int "year") }}
                        {{ else if $isSeason }}
                          {{ $img = $v.String "parent_thumb" }}
                          {{ $title = $v.String "parent_title" }}
                          {{ $sub = $v.String "title" }}
                        {{ else if $isShow }}
                          {{ $img = $v.String "thumb" }}
                          {{ $title = $v.String "title" }}
                          {{ $sub = printf "%d" ($v.Int "year") }}
                        {{ end }}
                        <a href="" target="_blank"
                          style="min-width: 160px; text-align: center; text-decoration: none;">
                          <div style="max-height: 225px; overflow: hidden; border-radius: 6px;">
                            <img src="${TAUTULLI_URL}/api/v2?apikey=${TAUTULLI_KEY}&cmd=pms_image_proxy&img={{ $img }}"
                              alt="thumb" title="{{ $title }}"
                              style="width: 100%; height: auto; object-fit: cover;" />
                          </div>
                          <div class="color-highlight" style="margin-top: 1rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;" title="{{ $title }}">
                            {{ $title }}
                          </div>
                          <div class="color-highlight" style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                            {{ $sub }}
                          </div>
                          <div class="color-primary" style="font-size: 0.9em;">
                            <span {{ parseRelativeTime "unix" $lastWatch }}></span> ago
                          </div>
                        </a>
                      {{ end }}
                    </div>
                    <!-- Right Arrow -->
                    <div id="scrollRight-{{ $uniqueID }}"
                      onclick='document.getElementById("scrollContainer-{{ $uniqueID }}").scrollBy({ left: 150, behavior: "smooth" })'
                      style="flex: 0 0 2.5rem; height: 100px; display: flex; align-items: center; justify-content: center; background: var(--color-surface); cursor: pointer;">
                      <span class="color-primary" style="font-size: 1.5rem; opacity: 0.7;">▶</span>
                    </div>
                  </div>
                {{ else }}
                  <!-- Small View -->
                  <ul class="list collapsible-container" data-collapse-after="{{ $collapse }}">
                    {{ range $i, $v := $rows }}
                      {{ $type := $v.String "media_type" }}
                      {{ $isEpisode := eq $type "episode" }}
                      {{ $isMovie := eq $type "movie" }}
                      {{ $isSeason := eq $type "season" }}
                      {{ $isShow := eq $type "show" }}
                      {{ $ratingKey := $v.String "rating_key" }}
                      {{ $lastWatch := printf "%d" ($v.Int "added_at") }}
                      {{ $img := "" }}
                      {{ $title := "" }}
                      {{ $sub := "" }}
                      {{ if $isEpisode }}
                        {{ $img = $v.String "grandparent_thumb" }}
                        {{ $title = $v.String "grandparent_title" }}
                        {{ $sub = printf "S%d · E%d" ($v.Int "parent_media_index") ($v.Int "media_index") }}
                      {{ else if $isMovie }}
                        {{ $img = $v.String "thumb" }}
                        {{ $title = $v.String "title" }}
                        {{ $sub = printf "%d" ($v.Int "year") }}
                      {{ else if $isSeason }}
                        {{ $img = $v.String "parent_thumb" }}
                        {{ $title = $v.String "parent_title" }}
                        {{ $sub = $v.String "title" }}
                      {{ else if $isShow }}
                        {{ $img = $v.String "thumb" }}
                        {{ $title = $v.String "title" }}
                        {{ $sub = printf "%d" ($v.Int "year") }}
                      {{ end }}
                      <li class="flex items-center gap-2" style="padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                        <img src="${TAUTULLI_URL}/api/v2?apikey=${TAUTULLI_KEY}&cmd=pms_image_proxy&img={{ $img }}" 
                          alt="thumb" style="width: 50px; margin-right: 1.5rem;" class="rounded w-10 h-10 object-cover" />
                        <div class="min-width-0 grow">
                          <div class="color-highlight" style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis;" title="{{ $title }}">
                            {{ $title }}
                          </div>
                          <div class="color-highlight" style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                            {{ $sub }}
                          </div>
                          <div class="color-primary">
                            <span {{ parseRelativeTime "unix" $lastWatch }}></span> ago
                          </div>
                        </div>
                        <a href="" target="_blank"
                          class="color-primary">▶</a>
                      </li>
                    {{ end }}
                  </ul>
                {{ end }}

            - type: custom-api
              title: Trending Media
              title-url: ${OVERSEERR_URL}/discover/trending    # trending, movies, or tv
              url: ${OVERSEERR_URL}/api/v1/discover/trending   # trending, movies, or tv
              cache: 15m
              headers:
                accept: "application/json"
                x-api-key: ${OVERSEERR_KEY}
              parameters:
                language: "fr" # this can be changed to other languages if desired
                page: "1"
              options:
                show-media-type: true # set to false to hide the "| TV" or "| Movie" suffix
                show-media-desc: false # set to false to hide the media's summary
              template: |
                {{ $showMediaType := .Options.BoolOr "show-media-type" true }}
                {{ $showMediaDesc := .Options.BoolOr "show-media-desc" true }}

                {{ if eq .Response.StatusCode 200 }}
                  {{ $items := .JSON.Array "results" }}
                  {{ if gt (len $items) 0 }}
                    <ul class="list list-gap-10 collapsible-container" data-collapse-after="5">
                    {{ range $items }}
                      <li class="flex items-start gap-10 thumbnail-parent">
                        {{ $mediaType := .String "mediaType" }}
                        {{ $mediaTitle := "" }}
                        {{ $mediaTypeUpper := "" }}
                        {{ if eq $mediaType "movie" }} {{ $mediaTitle = .String "title" }} {{ $mediaTypeUpper = "Movie" }}{{ else }}{{ $mediaTitle = .String "name" }} {{ $mediaTypeUpper = "TV" }}{{ end }}
                        {{ $overseerrUrl := concat "${OVERSEERR_URL}" "/" $mediaType "/" ( .String "id" ) }}
                        {{ $tmdbUrl := concat "https://www.themoviedb.org" "/" $mediaType "/" ( .String "id" ) }}
                        <a href={{ $overseerrUrl }} target="_blank">
                        <img src={{ concat "https://image.tmdb.org/t/p/w300" (.String "posterPath") }} style="border-radius: 5px; min-width: 5rem; max-width: 5rem;" class="card">
                        </a>
                        <div class="flex-1" style="padding-right: 5px;">
                          <p class="color-positive size-h4 text-truncate-2-lines margin-top-5" title={{ $mediaTitle }}><a href={{ $overseerrUrl }} target="_blank">{{ $mediaTitle }}</p>
                          <p class="size-h4" title="TMDB Rating"><a href={{ $tmdbUrl }} target="_blank">TMDB: {{ mul (.Float "voteAverage") 10 | toInt }}% {{ if $showMediaType }}| {{ $mediaTypeUpper }}{{ end }}</a></p>
                          {{ if $showMediaDesc }}<p class="color-subdue size-h4 text-truncate-2-lines" title={{ .String "overview" }}>{{ .String "overview" }}</p>{{ end }}
                        </div>
                      </li>
                    {{ end }}
                    </ul>
                  {{ else }}
                    <details style="margin-top:0.5rem">
                      <summary> Raw JSON:</summary>
                      <pre stye="font-size:10px">
                  {{ (printf "%+v" .JSON) }}
                      </pre>
                    </details>
                  {{ end }}
                {{ end }}
                
    - size: small
      widgets:
        - type: monitor
          cache: 1m
          title: Services
          style: compact
          sites:            
            - title: Overseerr
              url: http://192.168.0.26:5055/
            - title: Radarr
              url: http://192.168.0.26:7878
            - title: Sonarr
              url: http://192.168.0.26:8989
            - title: Plex
              url: http://192.168.0.26:32400/web/
            - title: Prawlarr
              url: http://192.168.0.26:9696/
            - title: Qbittorrent
              url: http://192.168.0.26:8080/
            - title: Tautulli
              url: http://192.168.0.26:8181/

        - type: custom-api
          title: Plex statistics
          cache: 6h
          allow-insecure: true
          url: ${TAUTULLI_URL}/api/v2
          parameters:
            apikey: ${TAUTULLI_KEY}
            cmd: get_libraries
          template: |
            <div class="flex justify-between text-center">
              {{ range .JSON.Array "response.data" }}
                <div>
                    <div class="color-highlight size-h3">{{ .Int "count" }}</div>
                    <div class="size-h6">{{ .String "section_name" }}</div>
                </div>
              {{ end }}
            </div>

        - type: custom-api
          title: Prowlarr Indexers
          cache: 1m
          options:
            url: "${PROWLARR_URL}"
            base-url: ${PROWLARR_API_URL}
            api-key: ${PROWLARR_KEY}
            collapse-after: 5
          template: |
            {{ $apiBaseUrl := .Options.StringOr "base-url" "" }}
            {{ $key := .Options.StringOr "api-key" "" }}
            {{ $url := .Options.StringOr "url" "" }}
            {{ $collapseAfter := .Options.IntOr "collapse-after" 5 }}
            {{ if or (eq $apiBaseUrl "") (eq $key "") (eq $url "") }}
              <div class="widget-error-header">
                  <div class="color-negative size-h3">ERROR</div>
                  <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
                  </svg>
                </div>
                <p class="break-all">
                  Some options are not set or malformed
                    <table style="border-spacing: 1rem;">
                      <tr>
                        <td><strong>PROWLARR_URL & PROWLARR_API_URL</strong> <br/> should include http(s):// and port if needed</td>
                      </tr>
                      <tr>
                        <td><strong>PROWLARR_KEY</strong> <br/> must be set (Settings > General > Security)</td>
                      </tr>
                    </table> 
                </p>
            {{ else }}
              {{ $indexUrl := printf "%s/api/v1/indexer" $apiBaseUrl }}
              {{ $indexData := newRequest $indexUrl
                | withHeader "Accept" "application/json"
                | withHeader "X-Api-Key" $key
                | getResponse }}
              {{ if eq $indexData.Response.StatusCode 200 }}
                <style>
                  .prowlarr-indexers .prowlarr-index-item
                  {
                    align-items: center;        
                  }
                  .prowlarr-indexers .prowlarr-index-item > span{
                    text-transform: capitalize;
                    background: var(--color-background);
                    padding: 0.2rem 0.75rem;
                    border: 1px solid var(--color-widget-content-border);
                    border-radius: var(--border-radius);
                    font-size: var(--font-size-tiny);
                  }
                </style>
          
                <ul class="prowlarr-indexers list list-gap-10 collapsible-container" data-collapse-after="{{ $collapseAfter }}">
                  {{ range $indexData.JSON.Array "" }}
                    {{ $isEnabled := .String "enable" }}
              
                    <li class="flex items-center gap-12 prowlarr-index-item">
                      <a href="{{ $url }}" target="_blank" class="size-title-dynamic color-highlight text-truncate block grow">{{ .String "name" }}</a>
                      <span>{{ .String "privacy" }}</span>
                      {{ if eq $isEnabled "true" }}
                        <div class="margin-left-auto shrink-0" data-popover-type="text" data-popover-position="above" data-popover-text="Enabled" aria-label="Enabled">
                          <div class="monitor-site-status-icon-compact" title="Enabled">
                            <svg fill="var(--color-positive)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd"></path>
                            </svg>
                          </div>
                        </div>
                      {{ else }}
                        <div class="margin-left-auto shrink-0" data-popover-type="text" data-popover-position="above" data-popover-text="Disabled" aria-label="Disabled">
                          <div class="monitor-site-status-icon-compact" title="Disabled">
                            <svg fill="var(--color-negative)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495ZM10 5a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 10 5Zm0 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd"></path>
                            </svg>
                          </div>
                        </div>
                      {{ end }}
                      
                    </li>
                  {{ end }}
                </ul>
              {{ else }}
                <p>Failed to fetch data (Status: {{ $indexData.Response.StatusCode }})</p>
              {{ end }}
            {{ end }}
          
        - type: custom-api
          title: "Playing"
          cache: 5m
          url: ${TAUTULLI_URL}/api/v2?apikey=${TAUTULLI_KEY}&cmd=get_activity
          template: |
            {{ $sessions := .JSON.Array "response.data.sessions" }}
            {{ $collapse := .Options.IntOr "collapse" 5 }}
            {{ if eq (len $sessions) 0 }}
              <div class="color-dim">No one is watching anything right now.</div>
            {{ else }}
              <ul class="list collapsible-container" data-collapse-after="{{ $collapse }}">
                {{ range $session := $sessions }}
                  {{ $type := $session.String "media_type" }}
                  {{ $isEpisode := eq $type "episode" }}
                  {{ $isMovie := eq $type "movie" }}
                  {{ $thumb := "" }}
                  {{ $title := "" }}
                  {{ $subtitle := "" }}
                  {{ if $isEpisode }}
                    {{ $title = $session.String "grandparent_title" }}
                    {{ $subtitle = printf "S%02dE%02d - %s" ($session.Int "parent_media_index") ($session.Int "media_index") ($session.String "title") }}
                    {{ $thumb = $session.String "grandparent_thumb" }}
                  {{ else }}
                    {{ $title = $session.String "title" }}
                    {{ $thumb = $session.String "thumb" }}
                  {{ end }}
                  {{ $duration := $session.Int "duration" }}
                  {{ $offset := $session.Int "view_offset" }}
                  {{ $remaining := div (sub $duration $offset) 1000 }}
                  {{ $now := now }}
                  {{ $endTime := $now.Add (duration (printf "%ds" $remaining)) | formatTime "3:04PM" }}
                  {{ $ratingKey := $session.String "rating_key" }}
                  <li class="flex items-center gap-2" style="padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                    <a href=""
                      title="{{ $session.String "summary" }}">
                      <img
                        src="${TAUTULLI_URL}/api/v2?apikey=${TAUTULLI_KEY}&cmd=pms_image_proxy&img={{ $thumb }}"
                        alt="thumb"
                        style="width: 50px; margin-right: 1.5rem;"
                        class="rounded object-cover"
                      />
                    </a>
                    <div class="min-width-0 grow">
                      <div class="color-highlight"
                        style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis;"
                        title="{{ $title }}">
                        {{ $title }}
                      </div>
                      {{ if $isEpisode }}
                        <div class="color-highlight" title="{{ $session.String "title" }}">
                          S{{ $session.Int "parent_media_index" }}&thinsp;·&thinsp;E{{ $session.Int "media_index" }}
                        </div>
                      {{ else if $isMovie }}
                        <div class="color-highlight" title="{{ $session.String "summary" }}">
                          {{ $session.Int "year" }}
                        </div>
                      {{ end }}
                      <div class="color-primary">
                        <span title="{{ $session.String "player" }}">
                          {{ $session.String "friendly_name" }}
                        </span> •
                        <span title="Ends at: {{ $endTime }}">
                          {{ $session.String "progress_percent" }}% watched
                        </span>
                      </div>
                    </div>
                  </li>
                {{ end }}
              </ul>
            {{ end }}